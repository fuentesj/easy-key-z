---
- hosts: ec2
  remote_user: ubuntu
  sudo: True
  vars:
    wsgi_file: rest_api.py
    wsgi_callable: app

  tasks:

    - name: Install pip
      apt: pkg=python-pip update_cache=yes

    - name: Install git
      apt: pkg=git

    - name: Install python-dev
      apt: pkg=python-dev

    - name: Install libffi-dev
      apt: pkg=libffi-dev

    - name: Install libssl-dev
      apt: pkg=libssl-dev

    - name: Install nginx
      apt: pkg=nginx

    - name: Install virtualenv
      pip: name=virtualenv

    - name: Install uwsgi
      pip: name=uwsgi

    - name: Pull easy-key-z source code
      git: repo=https://github.com/fuentesj/easy-key-z.git dest=/opt/easy-key-z

    - name: Install requirements.txt
      pip: requirements=/opt/easy-key-z/server/requirements.txt extra_args=--ignore-installed

    - name: Create directory for private keys
      file:
        state: directory
        path: /opt/easy-key-z/server/private_keys
        mode: 0775

    - name: Create directory for certificate signing requests
      file:
        state: directory
        path: /opt/easy-key-z/server/certificate_signing_requests
        mode: 0775

    - name: Create directory for certificates
      file:
        state: directory
        path: /opt/easy-key-z/server/certificates
        mode: 0775

    - name: Install upstart script for uwsgi
      template: src=server/easy-key-z.conf dest=/etc/init/easy-key-z.conf

    - name: Create dir for easy-key-z within nginx sites-available dir
      file:
        state: directory 
        path: /etc/nginx/sites-available/easy-key-z

    - name: Create log directory
      file:
        state: directory
        path: /tmp/easy-key-z-log/
        owner: ubuntu
        group: www-data
        mode: 0775

    - name: Create log file
      file:
        state: touch
        path: /tmp/easy-key-z-log/server.log
        owner: ubuntu
        group: www-data
        mode: 0775

    - name: Install nginx config file 
      template: src=server/easy-key-z-nginx-config dest=/etc/nginx/sites-available

    - name: Add symlink betwen sites-available and sites-enabled
      file:
        src: /etc/nginx/sites-available/easy-key-z-nginx-config
        dest: /etc/nginx/sites-enabled/easy-key-z
        state: link
        force: yes

    - name: Restart uwsgi
      service: name=easy-key-z state=restarted 

    - name: Restart nginx
      service: name=nginx state=restarted
